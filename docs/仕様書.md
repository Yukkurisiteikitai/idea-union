# LM Studioを利用したサービスアイデア生成システム 仕様書

## 概要
このシステムは、LM Studioの大規模言語モデル(LLM)を利用して、複数の要素を組み合わせた革新的なサービスアイデアを自動生成し、その中から優れたアイデアを選定するツールです。CSVファイルから読み込んだ要素を組み合わせ、AIによるビジョナリーサービスデザインを行います。

## システム要件
- Python 3.8以上
- LM Studio（ローカルLLMサーバー）
- 必要なPythonパッケージ：
  - openai（AsyncOpenAI）
  - asyncio
  - その他標準ライブラリ（csv, random, json, time, os, datetime, signal, sys）

## 設定パラメータ

| 変数名 | デフォルト値 | 説明 |
|:--|:--|:--|
| LMSTUDIO_BASE_URL | "http://localhost:1234/v1" | LM StudioのAPIエンドポイントURL。LM Studioを起動して「Start」ボタンを押した後に表示されるURLに `/v1` を追加したもの。 |
| API_KEY | "lm-studio" | LM StudioのAPI認証に使用するキー。OpenAI互換APIのため必要だが、実際の認証は行われない。 |
| MODEL_NAME | "gemma-3-12b-it" | 使用するLLMモデルの名前。他にも "deepseek-r1-distill-qwen-32b" や "qwen2.5-bakeneko-32b-instruct" などが利用可能。 |
| CSV_FILENAME | "q.csv" | アイデア生成の元となる要素リストを含むCSVファイルの名前。 |
| GOOD_SERVICE_FILENAME | "good-service.json" | 選定された優良サービスアイデアを保存するJSONファイルの名前。 |
| ALL_IDEAS_FILENAME_PREFIX | "all_ideas_" | 生成されたすべてのアイデアを保存するファイル名の接頭辞。実際のファイル名はこれにタイムスタンプが追加される。 |
| IDEAS_PER_CYCLE | 5 | 1サイクルあたりに生成するアイデアの数。 |
| NUM_ELEMENTS_TO_COMBINE | 3 | アイデア生成時に組み合わせる要素の数。3つの要素を「〇〇 × △△ × ◇◇」という形式で組み合わせる。 |

## システムプロンプト
システムには2種類のプロンプトが設定されています：

1. **ビジョナリーデザイナープロンプト（VISIONARY_DESIGNER_SYS_PROMPT）**：
   - アイデア生成時に使用される詳細なシステムプロンプト
   - ビジョナリーサービスデザイナーとしての役割とアイデア生成の指針を提供
   - コンセプトの核心、体験のデザイン、社会実装へのロードマップなどの観点を含む

2. **選定プロンプト（SELECTION_SYS_PROMPT）**：
   - 生成されたアイデアから優れたものを選ぶときに使用されるプロンプト
   - ビジネスアナリストとしての評価視点を設定

## 主な機能

### 1. 初期化と接続テスト
- AsyncOpenAIクライアントの初期化
- LM Studio APIへの接続テスト

### 2. CSVからの要素読み込み
- 指定されたCSVファイルから要素リストを読み込む
- 十分な要素数があるか検証

### 3. サービスアイデア生成
- ランダムに選択した要素の組み合わせを基にAIがサービスアイデアを生成
- 非同期処理でIDEAS_PER_CYCLE個のアイデアを並列生成
- 生成したアイデアから以下の情報を抽出：
  - 使用した要素の組み合わせ
  - サービス名（AIの回答から抽出）
  - アイデアの詳細テキスト（raw_text）

### 4. ベストアイデア選定
- 生成されたアイデアから優れたものを3つまで選定
- アイデアの番号、サービス名、選定理由を含む結果を出力

### 5. データ保存
- すべての生成アイデアをタイムスタンプ付きJSONファイルに保存
- 選定された優良アイデアを指定のJSONファイルに保存

### 6. 制御フロー
- サイクル単位での処理
- シグナルハンドリング（Ctrl+Cでの安全な停止）
- 非同期処理による効率的な実行

## 実行フロー
1. OpenAIクライアントを初期化
2. API接続をテスト
3. CSVファイルから要素を読み込み
4. 各サイクルで以下を実行：
   - ランダムな要素組み合わせでアイデア生成タスクを作成
   - 並列処理でアイデアを生成
   - すべての生成アイデアをJSONファイルに保存
   - ベストアイデアを選定して別のJSONファイルに保存
   - 次のサイクルまで待機（5秒）
5. シグナル受信またはエラーで安全に終了

## エラーハンドリング
- クライアント初期化エラー
- API接続エラー
- ファイル読み込みエラー
- 要素数不足エラー
- アイデア生成中のエラー
- ベストアイデア選定中のエラー
- ファイル保存エラー

## 制約事項
- LM Studioが起動し、モデルがロードされている必要がある
- CSVファイルには十分な数の要素が必要（NUM_ELEMENTS_TO_COMBINE以上）
- 大量の並列処理を行うため、システムリソースに余裕が必要

## 出力ファイル
1. **all_ideas_[タイムスタンプ].json**：各サイクルで生成されたすべてのアイデア
2. **good-service.json**：各サイクルで選定された優良なアイデア（最大3つ）